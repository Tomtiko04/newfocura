// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // OAuth
  googleId      String?   @unique
  appleId       String?   @unique
  
  // Relations
  goals         Goal[]
  yearlyGoals   YearlyGoal[]
  tasks         Task[]
  reflections   Reflection[]
  snaps         Snap[]
  schedules     Schedule[]
  energyPatterns EnergyPattern[]
  dailyBioSyncs DailyBioSync[]
  momentumScores MomentumScore[]
}

model Goal {
  id                String   @id @default(cuid())
  userId            String
  title             String
  description       String?  // "The Why"
  deadline          DateTime
  feasibilityScore  Float?
  feasibilityAnalysis String? // JSON string of analysis
  strategicPivot    String?  // Suggested pivot if not feasible
  status            String   @default("active") // active, completed, paused
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model YearlyGoal {
  id                 String   @id @default(cuid())
  userId             String
  title              String
  why                String?
  startDate          DateTime?
  endDate            DateTime?
  feasibilityScore   Float?
  feasibilityComment String?
  strategicPivot     String?
  estimatedHours     Float?
  priorityOrder      Int?
  status             String   @default("draft") // draft, analyzed, finalized
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
}

model Task {
  id                    String   @id @default(cuid())
  userId                String
  goalId                String?
  title                 String
  description           String?
  priority              Int      @default(3) // 1-5
  energyRequirement     String   // High, Medium, Low
  implementationIntention String // Peter Gollwitzer format
  status                String   @default("pending") // pending, in_progress, completed, cancelled
  scheduledTime         DateTime?
  scheduledEnergyWindow String?  // morning_peak, afternoon_admin, evening_reflection
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  completedAt           DateTime?
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subtasks              Subtask[]
  
  @@index([userId])
  @@index([status])
  @@index([scheduledTime])
}

model Subtask {
  id              String   @id @default(cuid())
  taskId          String
  title           String
  durationEstimate Int     // minutes, max 15
  status          String   @default("pending") // pending, completed
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@index([taskId])
}

model Reflection {
  id          String   @id @default(cuid())
  userId      String
  content     String
  date        DateTime @default(now())
  vectorId    String?  // Pinecone vector ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([date])
}

model Snap {
  id              String   @id @default(cuid())
  userId          String
  imageUrl        String
  extractedData   Json     // SnapResponse JSON
  vectorSyncStatus String  @default("pending") // pending, syncing, completed, failed
  vectorId        String?  // Pinecone vector ID
  createdAt       DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
}

model Schedule {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  tasks           Json     // Array of task IDs with time slots
  energyWindows   Json     // Energy windows for the day
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model EnergyPattern {
  id              String   @id @default(cuid())
  userId          String
  chronotype      String?  // early_bird, night_owl, balanced
  peakEnergyStart String?  // HH:mm format
  peakEnergyEnd   String?  // HH:mm format
  lowEnergyStart  String?  // HH:mm format
  lowEnergyEnd     String?  // HH:mm format
  averageSleepHours Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model DailyBioSync {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime @default(now())
  sleepTime     DateTime
  wakeTime      DateTime
  initialFocus  Int      // 1-5 scale
  actualPeaks   Json?    // Array of timestamps where user reported high focus
  sleepDebt     Float?   // hours of deficit
  sleepInertia  Int?     // minutes until first peak focus
  energyBaseline Float?  // 1-5 scale
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model MomentumScore {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  consistency     Boolean  // did â‰¥1 subtask?
  energyAlignment Float    // 0-1, task completion vs energy peak sync
  recovery        Float    // 0-1, sleep/wake consistency
  overallScore    Float    // 0-100, calculated from above metrics
  createdAt       DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

